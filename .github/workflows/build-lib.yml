name: Build Android Library

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android-lib:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # ç¼–è¯‘ debug å’Œ release ä¸¤ä¸ªç‰ˆæœ¬
        build_type: [debug, release]
        # æ”¯æŒå¤šä¸ªæž¶æž„
        target: [aarch64, armv7, x86_64]
        include:
          - target: aarch64
            rust_target: aarch64-linux-android
            ndk_target: arm64-v8a
            ndk_clang: aarch64-linux-android21-clang
          - target: armv7
            rust_target: armv7-linux-androideabi
            ndk_target: armeabi-v7a
            ndk_clang: armv7a-linux-androideabi21-clang
          - target: x86_64
            rust_target: x86_64-linux-android
            ndk_target: x86_64
            ndk_clang: x86_64-linux-android21-clang

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust Android target
      run: rustup target add ${{ matrix.rust_target }}

    - name: Download and install Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r27b-linux.zip -O ndk.zip
        unzip -q ndk.zip
        mv android-ndk-r27b $HOME/ndk
        echo "NDK_HOME=$HOME/ndk" >> $GITHUB_ENV

    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    - name: Configure .cargo/config.toml
      run: |
        mkdir -p .cargo
        echo '[target.${{ matrix.rust_target }}]' > .cargo/config.toml
        echo 'ar = "${{ env.NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"' >> .cargo/config.toml
        echo 'linker = "${{ env.NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.ndk_clang }}"' >> .cargo/config.toml

    - name: Build library (debug)
      if: matrix.build_type == 'debug'
      run: cargo ndk -t ${{ matrix.ndk_target }} build --lib

    - name: Build library (release)
      if: matrix.build_type == 'release'
      run: cargo ndk -t ${{ matrix.ndk_target }} build --lib --release

    - name: Verify library output
      run: |
        if [ "${{ matrix.build_type }}" == "debug" ]; then
          ls -lh target/${{ matrix.rust_target }}/debug/libhackcomp.so
          file target/${{ matrix.rust_target }}/debug/libhackcomp.so
        else
          ls -lh target/${{ matrix.rust_target }}/release/libhackcomp.so
          file target/${{ matrix.rust_target }}/release/libhackcomp.so
        fi

    - name: Strip release binary
      if: matrix.build_type == 'release'
      run: |
        ${{ env.NDK_HOME }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
          target/${{ matrix.rust_target }}/release/libhackcomp.so

    - name: Upload artifact (debug)
      if: matrix.build_type == 'debug'
      uses: actions/upload-artifact@v4
      with:
        name: libhackcomp-${{ matrix.target }}-debug
        path: target/${{ matrix.rust_target }}/debug/libhackcomp.so

    - name: Upload artifact (release)
      if: matrix.build_type == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: libhackcomp-${{ matrix.target }}-release
        path: target/${{ matrix.rust_target }}/release/libhackcomp.so

  # æ‰“åŒ…æ‰€æœ‰æž¶æž„çš„åº“åˆ°ä¸€ä¸ª zip æ–‡ä»¶
  package-all:
    needs: build-android-lib
    runs-on: ubuntu-latest

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Create package structure
      run: |
        mkdir -p package/lib/arm64-v8a
        mkdir -p package/lib/armeabi-v7a
        mkdir -p package/lib/x86_64

        # å¤åˆ¶ release ç‰ˆæœ¬ï¼ˆæŽ¨èç”¨äºŽç”Ÿäº§ï¼‰
        cp artifacts/libhackcomp-aarch64-release/libhackcomp.so package/lib/arm64-v8a/
        cp artifacts/libhackcomp-armv7-release/libhackcomp.so package/lib/armeabi-v7a/
        cp artifacts/libhackcomp-x86_64-release/libhackcomp.so package/lib/x86_64/

        # åˆ›å»ºè°ƒè¯•ç‰ˆæœ¬ç›®å½•
        mkdir -p package-debug/lib/arm64-v8a
        mkdir -p package-debug/lib/armeabi-v7a
        mkdir -p package-debug/lib/x86_64

        cp artifacts/libhackcomp-aarch64-debug/libhackcomp.so package-debug/lib/arm64-v8a/
        cp artifacts/libhackcomp-armv7-debug/libhackcomp.so package-debug/lib/armeabi-v7a/
        cp artifacts/libhackcomp-x86_64-debug/libhackcomp.so package-debug/lib/x86_64/

    - name: Create README
      run: |
        cat > package/README.md << 'EOF'
        # Hackcomp Android Library

        ## æ–‡ä»¶è¯´æ˜Ž

        - `lib/arm64-v8a/libhackcomp.so` - ARM64 æž¶æž„ï¼ˆçŽ°ä»£ 64 ä½ Android è®¾å¤‡ï¼‰
        - `lib/armeabi-v7a/libhackcomp.so` - ARMv7 æž¶æž„ï¼ˆæ—§çš„ 32 ä½è®¾å¤‡ï¼‰
        - `lib/x86_64/libhackcomp.so` - x86_64 æž¶æž„ï¼ˆæ¨¡æ‹Ÿå™¨ï¼‰

        ## ä½¿ç”¨æ–¹å¼

        ### 1. LSPosed æ¨¡å—é›†æˆ

        å°† `lib` ç›®å½•å¤åˆ¶åˆ°æ‚¨çš„ LSPosed æ¨¡å—é¡¹ç›®çš„ `src/main/jniLibs/` ç›®å½•ï¼š

        ```
        YourLSPosedModule/
        â””â”€â”€ app/
            â””â”€â”€ src/
                â””â”€â”€ main/
                    â””â”€â”€ jniLibs/
                        â”œâ”€â”€ arm64-v8a/
                        â”‚   â””â”€â”€ libhackcomp.so
                        â”œâ”€â”€ armeabi-v7a/
                        â”‚   â””â”€â”€ libhackcomp.so
                        â””â”€â”€ x86_64/
                            â””â”€â”€ libhackcomp.so
        ```

        ### 2. åœ¨ Java ä»£ç ä¸­åŠ è½½

        ```java
        static {
            System.loadLibrary("hackcomp");
        }
        ```

        ### 3. é€šè¿‡ JNI è°ƒç”¨

        éœ€è¦åœ¨ Rust ä»£ç ä¸­å®žçŽ° JNI æŽ¥å£ï¼ˆå¾…åŽç»­æ·»åŠ ï¼‰ã€‚

        ## ç‰ˆæœ¬ä¿¡æ¯

        - æž„å»ºæ—¶é—´: $(date -u)
        - Git Commit: ${GITHUB_SHA:0:7}
        - Build Type: Release (stripped)

        ## æž¶æž„é€‰æ‹©

        - å¤§å¤šæ•°çŽ°ä»£ Android è®¾å¤‡ä½¿ç”¨ **arm64-v8a**
        - æ¨¡æ‹Ÿå™¨é€šå¸¸ä½¿ç”¨ **x86_64**
        - å¦‚æžœä¸ç¡®å®šï¼ŒåŒ…å«æ‰€æœ‰æž¶æž„ï¼ŒAndroid ä¼šè‡ªåŠ¨é€‰æ‹©
        EOF

        cp package/README.md package-debug/README.md

    - name: Create zip packages
      run: |
        cd package && zip -r ../hackcomp-android-libs-release.zip . && cd ..
        cd package-debug && zip -r ../hackcomp-android-libs-debug.zip . && cd ..

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: hackcomp-android-libs-release
        path: hackcomp-android-libs-release.zip

    - name: Upload debug package
      uses: actions/upload-artifact@v4
      with:
        name: hackcomp-android-libs-debug
        path: hackcomp-android-libs-debug.zip

    - name: Generate build summary
      run: |
        echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Successfully built libhackcomp.so for all architectures" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### File Sizes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Release (Stripped)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh package/lib/*/libhackcomp.so >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Debug (With Symbols)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -lh package-debug/lib/*/libhackcomp.so >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download" >> $GITHUB_STEP_SUMMARY
        echo "- Download artifacts from the 'Artifacts' section above" >> $GITHUB_STEP_SUMMARY
        echo "- Use **release** version for production" >> $GITHUB_STEP_SUMMARY
        echo "- Use **debug** version for development (contains symbols)" >> $GITHUB_STEP_SUMMARY
